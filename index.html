<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>CTAP thirdPartyPayment + SPC Sample</title>
</head>
<body>
  <h1>CTAP thirdPartyPayment + SPC Sample</h1>

  <button id="registerBtn">Register Credential</button>
  <button id="payBtn">Pay $3.50</button>

  <script>
    // register
    async function registerCredential() {
      try {
        const publicKey = {
          challenge: crypto.getRandomValues(new Uint8Array(32)),
          rp: {
            id: "theosusi.github.io", 
            name: "CTAP Test RP"
          },
          user: {
            id: crypto.getRandomValues(new Uint8Array(16)),
            name: "testuser@example.com",
            displayName: "Test User"
          },
          pubKeyCredParams: [{ type: "public-key", alg: -7 }],
          attestation: "none",
          extensions: {
            thirdPartyPayment: {
              tppId: "sandbox-tpp-001",
              payee: "coffee-shop",
              amount: 3.50,
              currency: "USD"
            }
          }
        };

        const credential = await navigator.credentials.create({ publicKey });
        console.log("Credential created:", credential);

        // Credential ID to base 64 and save (for SPC)
        const credIdBase64 = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));
        localStorage.setItem("credentialId", credIdBase64);
        alert("Credential registered and saved.");
      } catch (e) {
        console.error(e);
        alert("Registration failed: " + e.message);
      }
    }

    async function makePayment() {
      try {
        if (!window.PaymentRequest) {
          alert("PaymentRequest API is not supported.");
          return;
        }

        const credIdBase64 = localStorage.getItem("credentialId");
        if (!credIdBase64) {
          alert("Credential ID not found. Please register first.");
          return;
        }
        // Base64 -> Uint8Array
        const credId = Uint8Array.from(atob(credIdBase64), c => c.charCodeAt(0));

        const paymentDetails = {
          total: {
            label: "Total",
            amount: { currency: "USD", value: "3.50" }
          }
        };

        const methodData = [{
          supportedMethods: "secure-payment-confirmation",
          data: {
            rpId: "theosusi.github.io",  
            payeeOrigin: "https://theosusi.github.io", 
            credentialIds: [credId.buffer],
            instrument: {
              displayName: "Coffee Shop",
              icon: "https://example.com/coffee-icon.png"
            },
            challenge: crypto.getRandomValues(new Uint8Array(32)).buffer,
            timeout: 60000
          }
        }];

        const request = new PaymentRequest(methodData, paymentDetails);
        const response = await request.show();
        await response.complete("success");
        alert("Payment authorized!");
        console.log("SPC response:", response);

      } catch (e) {
        console.error(e);
        alert("Payment failed: " + e.message);
      }
    }

    document.getElementById("registerBtn").addEventListener("click", registerCredential);
    document.getElementById("payBtn").addEventListener("click", makePayment);
  </script>
</body>
</html>